<!-- Initially generated by GitHub Copilot. -->
# Procedure: Generating Aleppo Codex Word Crops for Quirkrecs

This describes the workflow for supplying μA (Aleppo Codex) word-level
image crops to quirkrecs that lack them. It uses the column-coordinate
and line-break data already captured for all 24 Job pages (270r–281v).

## Overview

Each quirkrec that is missing a `qr-aleppo-img` needs a cropped PNG
of the relevant word from the Aleppo Codex manuscript image. The
workflow is:

1. **List missing** → identify which quirkrecs still need images
2. **Generate crop editor** → interactive HTML with draggable bounding
   boxes overlaid on the manuscript image
3. **User adjusts** → drag/nudge boxes to tightly frame each word
4. **Export JSON** → user clicks Export, copies bbox coordinates
5. **Apply crops** → download hi-res image, crop, save PNGs
6. **Rebuild HTML** → verify images appear in the output
7. **Show in browser** → open detail pages to visually confirm

## Prerequisites

All 24 Job pages (270r–281v) must have:
- Line-break data in `py_ac_loc/line-breaks/{page}.json`
- Column-coordinate data in `py_ac_loc/column-coordinates/{page}.json`

Both are already complete.

## Scripts

### `main_list_missing_aleppo_imgs.py`

Lists all quirkrecs that don't yet have an Aleppo image.

```
python main_list_missing_aleppo_imgs.py          # first 15 missing
python main_list_missing_aleppo_imgs.py --all    # all missing
python main_list_missing_aleppo_imgs.py -n 20    # first 20 missing
```

A quirkrec counts as "done" if `docs/jobn/img/Aleppo-{sid}.png` exists
or it already has a `qr-aleppo-img` key.

### `main_gen_word_crop_editor.py`

Generates an interactive HTML crop editor at `.novc/word_crop_editor.html`.

```
python main_gen_word_crop_editor.py 0417 0505 0520    # specific SIDs
python main_gen_word_crop_editor.py --all              # all missing
```

The script:
1. Loads each enriched quirkrec from `out/enriched-quirkrecs.json`
2. Locates the consensus word in the line-break data via
   `py_ac_word_image_helper/linebreak_search.py`
3. Computes pixel coordinates from column-coordinate data
4. Downloads manuscript images from archive.org at scale=2 (cached in
   `.novc/page_cache_{page}_s2.jpg`)
5. Generates crop-edit PNGs showing the target line with a fade overlay
   and the target word highlighted
6. Builds an interactive HTML editor with SVG overlays for each item

The HTML editor features:
- Draggable corner/side handles to resize the bounding box
- Fine mode (default, toggle with F key) — 1/5 sensitivity for
  precise adjustments
- Arrow keys to nudge the active side (1–4 keys select which side)
- Tab/Shift-Tab to cycle between items
- Reset button to restore initial bbox
- **Export JSON** button → copies all bbox coordinates to clipboard

### Apply crops (one-off scripts in `.novc/`)

After the user exports JSON from the editor, create a one-off script
(e.g., `.novc/apply_word_crops_batchN.py`) that:

1. Defines the `CROPS` list with `sid`, `page`, and `bbox_ref` for each
2. Downloads page images at scale=1 (2× the reference coordinates)
3. Scales `bbox_ref` by factor 2 and crops
4. Saves to `docs/jobn/img/Aleppo-{sid}.png`

Template:
```python
"""Apply word crop bounding boxes for batch N."""
import sys
from pathlib import Path
ROOT = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(ROOT))
from py_ac_word_image_helper.codex_page import download_page

OUT_DIR = ROOT / "docs" / "jobn" / "img"
CROPS = [
    {"sid": "XXXX", "page": "NNNx", "bbox_ref": {"x": ..., "y": ..., "w": ..., "h": ...}},
    # ...
]

def main():
    factor = 2.0  # scale=2 reference coords → scale=1 crop coords
    page_imgs = {}
    for crop in CROPS:
        page_id = crop["page"]
        if page_id not in page_imgs:
            page_imgs[page_id] = download_page(page_id, scale=1)
        img = page_imgs[page_id]
        bb = crop["bbox_ref"]
        x, y, w, h = [int(v * factor) for v in [bb["x"], bb["y"], bb["w"], bb["h"]]]
        cropped = img.crop((x, y, x + w, y + h))
        out_path = OUT_DIR / f"Aleppo-{crop['sid']}.png"
        cropped.save(out_path)
        print(f"  {out_path.name}: {cropped.size[0]}x{cropped.size[1]}")
    print(f"Done. {len(CROPS)} images saved.")

if __name__ == "__main__":
    main()
```

## Batch workflow (step by step)

Process quirkrecs in batches of ~5:

1. **List missing:**
   ```
   python main_list_missing_aleppo_imgs.py
   ```
   Pick the next 5 SIDs from the output.

2. **Generate crop editor:**
   ```
   python main_gen_word_crop_editor.py SID1 SID2 SID3 SID4 SID5
   ```
   Then open `.novc/word_crop_editor.html` in the browser.

3. **Adjust bounding boxes** in the editor, then click **Export JSON**.

4. **Paste the JSON** into the chat. The assistant creates an apply
   script in `.novc/`, runs it, and generates the PNGs.

5. **Rebuild HTML and verify:**
   ```
   python main_gen_misc_authored_english_documents.py
   git status --porcelain docs/
   ```

6. **Show in browser** (requires local HTTP server for fragment URLs):
   ```
   python -m http.server 8471 --directory docs
   ```
   Then open each detail page:
   ```
   http://localhost:8471/jobn/job1_full_list_details.html#row-SID
   ```

7. **Commit** when satisfied.

## Image naming convention

- `Aleppo-{short_id}.png` where `short_id` = `CCVV` or `CCVV_WORDID`
- Saved to `docs/jobn/img/`
- Typical size: ~130–430px wide, ~190–220px tall

## Scale conventions

- **scale=2** (~1660×1952 px): used as the reference coordinate system
  for column-coordinates and `bbox_ref` values
- **scale=1** (~3320×3904 px): used for final crops (2× bigger, giving
  crisp output at ~200px display width)
- Factor: multiply `bbox_ref` coordinates by 2.0 to get scale=1 pixels

## Key modules

- `py_ac_word_image_helper/linebreak_search.py` — `find_word_in_linebreaks()`
  locates a word in line-break data. Handles maqaf-joined consensus words
  (e.g., `הׇשְׁלְמָה־לָּֽךְ׃`) by joining adjacent maqaf-connected tokens.
- `py_ac_word_image_helper/codex_page.py` — `download_page()` fetches
  archive.org images with caching in `.novc/`.
- `py_ac_word_image_helper/hebrew_metrics.py` — `strip_heb()` strips
  cantillation and vowels for fuzzy word matching.
- `pyauthor_util/short_id_etc.py` — `short_id()` extracts the SID from
  a quirkrec.
- `pyauthor_util/img_util.py` — `get_auto_imgs()` auto-detects
  `Aleppo-{sid}.png` files and populates `qr-aleppo-img` in HTML output.
